---
description: "Environment, Architecture, and Virtualenv Awareness"
globs: ["**/*"]
alwaysApply: true
---

# Environment Rules (General)

1. **Virtual Environment**: The project uses a Python virtual environment (`.venv`).
2. **Execution**: When running python scripts, assume the environment is set up correctly in the user's terminal, OR explicitly check for `.venv/bin/python` if available.
3. **Dependency Management**: Do NOT attempt to `pip install` packages unless explicitly asked and after verifying they are missing from `requirements.txt`.
4. **Shell**: The shell tool might not inherit the active venv from the user's IDE state perfectly. If `ModuleNotFoundError` occurs, it's likely an environment mismatch, not a missing dependency in the project.

# Architectural Invariants (DO NOT BREAK)

1. **Portable Paths**: NEVER hardcode absolute paths. Use `REPO_ROOT` (dynamically calculated) or relative paths.
2. **Security**: Any file loading tool must prevent Path Traversal using `os.path.commonpath` checks against `REPO_ROOT`.
3. **Data Integrity (No Hallucinations)**: If you lack specific data or context (e.g., file not found, MCP tool returns empty, or knowledge is missing):
   - **STOP**. Do not invent or guess details.
   - Explicitly signal the missing data with a relevant emoji (e.g., ü§∑‚Äç‚ôÇÔ∏è, üö´, üì≠, üìâ) and a clear "No Data" statement.

# MCP & Engine Architecture (Applies when working on Agent Engine/MCP Server)

1. **Routing Truth**: `src/engine/router.py` is the SINGLE source of truth for the agent list (via dynamic scanning). Do not hardcode agent lists in Markdown rules.
2. **Langfuse Version**: The project uses `langfuse` v3+. Use `from langfuse import observe` instead of `from langfuse.decorators import observe`.
3. **Observability**: Logging must be implemented via middleware/decorators (e.g., `@trace_tool`) on the server side, not by relying on the LLM to call a logging tool.
4. **Async I/O**: The MCP server is async.
   - Database/File I/O: Must run in `loop.run_in_executor`.
   - External APIs: Must use async clients (e.g., `AsyncOpenAI`).
